global:
  scrape_interval:     <%= ENV["PROMETHEUS_GLOBAL_SCRAPE_INTERVAL"] || "1m" %>
  evaluation_interval: <%= ENV["PROMETHEUS_GLOBAL_EVALUATION_INTERVAL"] || "1m" %>
  external_labels:
    environment: <%= ENV["PROMETHEUS_ENVIRONMENT"] || "production" %>
    cluster: <%= ENV["PROMETHEUS_CLUSTER"] || "default" %>

# Configuration Remote Write vers InfluxDB v1.x
remote_write:
  - url: "<%= ENV["INFLUXDB_URL"] %>/write?db=<%= ENV["INFLUXDB_DB"] %>"
    basic_auth:
      username: "<%= ENV["INFLUXDB_USERNAME"] %>"
      password: "<%= ENV["INFLUXDB_PASSWORD"] %>"
    remote_timeout: <%= ENV["INFLUXDB_REMOTE_TIMEOUT"] || "30s" %>
    queue_config:
      capacity: <%= ENV["INFLUXDB_QUEUE_CAPACITY"] || "10000" %>
      max_shards: <%= ENV["INFLUXDB_MAX_SHARDS"] || "200" %>
      min_shards: <%= ENV["INFLUXDB_MIN_SHARDS"] || "1" %>
      max_samples_per_send: <%= ENV["INFLUXDB_MAX_SAMPLES_PER_SEND"] || "1000" %>
      batch_send_deadline: <%= ENV["INFLUXDB_BATCH_SEND_DEADLINE"] || "5s" %>
      min_backoff: <%= ENV["INFLUXDB_MIN_BACKOFF"] || "100ms" %>
      max_backoff: <%= ENV["INFLUXDB_MAX_BACKOFF"] || "10s" %>
    write_relabel_configs:
      - source_labels: [__name__]
        regex: '<%= ENV["INFLUXDB_METRICS_REGEX"] || ".*" %>'
        action: keep


scrape_configs:
  # Get Prometheus self-metrics
  - job_name: "prometheus"
    basic_auth:
      username: "<%= ENV["BASIC_AUTH_USERNAME"] %>"
      password: "<%= ENV["BASIC_AUTH_PASSWORD"] %>"
    static_configs:
      - targets: ["<%= ENV["CANONICAL_HOST"] %>"]

  # Node.js application metrics
  - job_name: "node-app"
    scrape_interval: <%= ENV["NODE_APP_SCRAPE_INTERVAL"] || "15s" %>
    scrape_timeout: <%= ENV["NODE_APP_SCRAPE_TIMEOUT"] || "10s" %>
    metrics_path: "/metrics"
    scheme: <%= ENV["NODE_APP_SCHEME"] || "https" %>
    static_configs:
      - targets: [<%= ENV["NODE_APP_TARGETS"] || '"poc-nodejs.osc-fr1.scalingo.io/metrics/"' %>]
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: "node_(.*)"
        target_label: "component"
        replacement: "nodejs"

  # Custom scraper metrics
  - job_name: "custom-scraper"
    scrape_interval: <%= ENV["CUSTOM_SCRAPER_SCRAPE_INTERVAL"] || "30s" %>
    scrape_timeout: <%= ENV["CUSTOM_SCRAPER_SCRAPE_TIMEOUT"] || "20s" %>
    metrics_path: "/scrape"
    scheme: <%= ENV["CUSTOM_SCRAPER_SCHEME"] || "https" %>
    static_configs:
      - targets: [<%= ENV["CUSTOM_SCRAPER_TARGETS"] || '"poc-logs-n8n.osc-fr1.scalingo.io"' %>]
    params:
      format: ["prometheus"]